!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("three")):"function"==typeof define&&define.amd?define(["exports","three"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).Nexus3D={},e.THREE)}(this,(function(e,t){"use strict";function r(e){var t=e.getUint32(e.offset,!0),r=e.getUint32(e.offset+4,!0);return e.offset+=8,1*r+t}function o(e){var t=e.getUint32(e.offset,!0);return e.offset+=4,t}function s(e){var t=e.getUint16(e.offset,!0);return e.offset+=2,t}function i(e){var t=e.getFloat32(e.offset,!0);return e.offset+=4,t}function a(e,t){var r=1/(e[12]*e[9]*e[6]*e[3]-e[8]*e[13]*e[6]*e[3]-e[12]*e[5]*e[10]*e[3]+e[4]*e[13]*e[10]*e[3]+e[8]*e[5]*e[14]*e[3]-e[4]*e[9]*e[14]*e[3]-e[12]*e[9]*e[2]*e[7]+e[8]*e[13]*e[2]*e[7]+e[12]*e[1]*e[10]*e[7]-e[0]*e[13]*e[10]*e[7]-e[8]*e[1]*e[14]*e[7]+e[0]*e[9]*e[14]*e[7]+e[12]*e[5]*e[2]*e[11]-e[4]*e[13]*e[2]*e[11]-e[12]*e[1]*e[6]*e[11]+e[0]*e[13]*e[6]*e[11]+e[4]*e[1]*e[14]*e[11]-e[0]*e[5]*e[14]*e[11]-e[8]*e[5]*e[2]*e[15]+e[4]*e[9]*e[2]*e[15]+e[8]*e[1]*e[6]*e[15]-e[0]*e[9]*e[6]*e[15]-e[4]*e[1]*e[10]*e[15]+e[0]*e[5]*e[10]*e[15]);t[0]=(e[9]*e[14]*e[7]-e[13]*e[10]*e[7]+e[13]*e[6]*e[11]-e[5]*e[14]*e[11]-e[9]*e[6]*e[15]+e[5]*e[10]*e[15])*r,t[1]=(e[13]*e[10]*e[3]-e[9]*e[14]*e[3]-e[13]*e[2]*e[11]+e[1]*e[14]*e[11]+e[9]*e[2]*e[15]-e[1]*e[10]*e[15])*r,t[2]=(e[5]*e[14]*e[3]-e[13]*e[6]*e[3]+e[13]*e[2]*e[7]-e[1]*e[14]*e[7]-e[5]*e[2]*e[15]+e[1]*e[6]*e[15])*r,t[3]=(e[9]*e[6]*e[3]-e[5]*e[10]*e[3]-e[9]*e[2]*e[7]+e[1]*e[10]*e[7]+e[5]*e[2]*e[11]-e[1]*e[6]*e[11])*r,t[4]=(e[12]*e[10]*e[7]-e[8]*e[14]*e[7]-e[12]*e[6]*e[11]+e[4]*e[14]*e[11]+e[8]*e[6]*e[15]-e[4]*e[10]*e[15])*r,t[5]=(e[8]*e[14]*e[3]-e[12]*e[10]*e[3]+e[12]*e[2]*e[11]-e[0]*e[14]*e[11]-e[8]*e[2]*e[15]+e[0]*e[10]*e[15])*r,t[6]=(e[12]*e[6]*e[3]-e[4]*e[14]*e[3]-e[12]*e[2]*e[7]+e[0]*e[14]*e[7]+e[4]*e[2]*e[15]-e[0]*e[6]*e[15])*r,t[7]=(e[4]*e[10]*e[3]-e[8]*e[6]*e[3]+e[8]*e[2]*e[7]-e[0]*e[10]*e[7]-e[4]*e[2]*e[11]+e[0]*e[6]*e[11])*r,t[8]=(e[8]*e[13]*e[7]-e[12]*e[9]*e[7]+e[12]*e[5]*e[11]-e[4]*e[13]*e[11]-e[8]*e[5]*e[15]+e[4]*e[9]*e[15])*r,t[9]=(e[12]*e[9]*e[3]-e[8]*e[13]*e[3]-e[12]*e[1]*e[11]+e[0]*e[13]*e[11]+e[8]*e[1]*e[15]-e[0]*e[9]*e[15])*r,t[10]=(e[4]*e[13]*e[3]-e[12]*e[5]*e[3]+e[12]*e[1]*e[7]-e[0]*e[13]*e[7]-e[4]*e[1]*e[15]+e[0]*e[5]*e[15])*r,t[11]=(e[8]*e[5]*e[3]-e[4]*e[9]*e[3]-e[8]*e[1]*e[7]+e[0]*e[9]*e[7]+e[4]*e[1]*e[11]-e[0]*e[5]*e[11])*r,t[12]=(e[12]*e[9]*e[6]-e[8]*e[13]*e[6]-e[12]*e[5]*e[10]+e[4]*e[13]*e[10]+e[8]*e[5]*e[14]-e[4]*e[9]*e[14])*r,t[13]=(e[8]*e[13]*e[2]-e[12]*e[9]*e[2]+e[12]*e[1]*e[10]-e[0]*e[13]*e[10]-e[8]*e[1]*e[14]+e[0]*e[9]*e[14])*r,t[14]=(e[12]*e[5]*e[2]-e[4]*e[13]*e[2]-e[12]*e[1]*e[6]+e[0]*e[13]*e[6]+e[4]*e[1]*e[14]-e[0]*e[5]*e[14])*r,t[15]=(e[4]*e[9]*e[2]-e[8]*e[5]*e[2]+e[8]*e[1]*e[6]-e[0]*e[9]*e[6]-e[4]*e[1]*e[10]+e[0]*e[5]*e[10])*r}function h(e){this.error=new Float32Array(e),this.data=new Int32Array(e),this.size=0}function u(){let e=this;e.maxBlocked=30,e.modelMatrix=new Float32Array(16),e.viewMatrix=new Float32Array(16),e.projectionMatrix=new Float32Array(16),e.modelView=new Float32Array(16),e.modelViewInv=new Float32Array(16),e.modelViewProj=new Float32Array(16),e.modelViewProjInv=new Float32Array(16),e.planes=new Float32Array(24),e.viewport=new Float32Array(4),e.viewpoint=new Float32Array(4)}h.prototype={push:function(e,t){this.data[this.size]=e,this.error[this.size]=t,this.bubbleUp(this.size),this.size++},pop:function(){var e=this.data[0];return this.size--,this.size>0&&(this.data[0]=this.data[this.size],this.error[0]=this.error[this.size],this.sinkDown(0)),e},bubbleUp:function(e){for(var t=this.data[e],r=this.error[e];e>0;){var o=(e+1>>1)-1,s=this.error[o];if(s>r)break;this.data[e]=this.data[o],this.error[e]=s,this.data[o]=t,this.error[o]=r,e=o}},sinkDown:function(e){for(var t=this.data[e],r=this.error[e];;){var o=2*(e+1),s=o-1,i=-1;if(s<this.size){var n=this.error[s];n>r&&(i=s)}if(o<this.size)this.error[o]>(-1==i?r:n)&&(i=o);if(-1==i)break;this.data[e]=this.data[i],this.error[e]=this.error[i],this.data[i]=t,this.error[i]=r,e=i}}},u.prototype={updateView:function(e,t,r){let o=this;for(let e=0;e<16;e++)o.projectionMatrix[e]=t[e],o.modelView[e]=r[e];for(let t=0;t<4;t++)o.viewport[t]=e[t];var s,i,n;s=o.projectionMatrix,i=o.modelView,(n=o.modelViewProj)[0]=s[0]*i[0]+s[4]*i[1]+s[8]*i[2]+s[12]*i[3],n[1]=s[1]*i[0]+s[5]*i[1]+s[9]*i[2]+s[13]*i[3],n[2]=s[2]*i[0]+s[6]*i[1]+s[10]*i[2]+s[14]*i[3],n[3]=s[3]*i[0]+s[7]*i[1]+s[11]*i[2]+s[15]*i[3],n[4]=s[0]*i[4]+s[4]*i[5]+s[8]*i[6]+s[12]*i[7],n[5]=s[1]*i[4]+s[5]*i[5]+s[9]*i[6]+s[13]*i[7],n[6]=s[2]*i[4]+s[6]*i[5]+s[10]*i[6]+s[14]*i[7],n[7]=s[3]*i[4]+s[7]*i[5]+s[11]*i[6]+s[15]*i[7],n[8]=s[0]*i[8]+s[4]*i[9]+s[8]*i[10]+s[12]*i[11],n[9]=s[1]*i[8]+s[5]*i[9]+s[9]*i[10]+s[13]*i[11],n[10]=s[2]*i[8]+s[6]*i[9]+s[10]*i[10]+s[14]*i[11],n[11]=s[3]*i[8]+s[7]*i[9]+s[11]*i[10]+s[15]*i[11],n[12]=s[0]*i[12]+s[4]*i[13]+s[8]*i[14]+s[12]*i[15],n[13]=s[1]*i[12]+s[5]*i[13]+s[9]*i[14]+s[13]*i[15],n[14]=s[2]*i[12]+s[6]*i[13]+s[10]*i[14]+s[14]*i[15],n[15]=s[3]*i[12]+s[7]*i[13]+s[11]*i[14]+s[15]*i[15],a(o.modelViewProj,o.modelViewProjInv),a(o.modelView,o.modelViewInv),o.viewpoint[0]=o.modelViewInv[12],o.viewpoint[1]=o.modelViewInv[13],o.viewpoint[2]=o.modelViewInv[14],o.viewpoint[3]=1;const h=o.modelViewProj,u=o.modelViewProjInv;let l=o.planes;l[0]=h[0]+h[3],l[1]=h[4]+h[7],l[2]=h[8]+h[11],l[3]=h[12]+h[15],l[4]=-h[0]+h[3],l[5]=-h[4]+h[7],l[6]=-h[8]+h[11],l[7]=-h[12]+h[15],l[8]=h[1]+h[3],l[9]=h[5]+h[7],l[10]=h[9]+h[11],l[11]=h[13]+h[15],l[12]=-h[1]+h[3],l[13]=-h[5]+h[7],l[14]=-h[9]+h[11],l[15]=-h[13]+h[15],l[16]=-h[2]+h[3],l[17]=-h[6]+h[7],l[18]=-h[10]+h[11],l[19]=-h[14]+h[15],l[20]=-h[2]+h[3],l[21]=-h[6]+h[7],l[22]=-h[10]+h[11],l[23]=-h[14]+h[15];for(let e=0;e<24;e+=4){let t=Math.sqrt(l[e]*l[e]+l[e+1]*l[e+1]+l[e+2]*l[e+2]);l[e]/=t,l[e+1]/=t,l[e+2]/=t,l[e+3]/=t}const c=u[3]+u[15],f=(u[0]+u[12])/c,d=(u[1]+u[13])/c,m=(u[2]+u[14])/c,p=-u[3]+u[15],x=(-u[0]+u[12])/p-f,v=(-u[1]+u[13])/p-d,b=(-u[2]+u[14])/p-m,w=Math.sqrt(x*x+v*v+b*b),g=u[12]/u[15]-o.viewpoint[0],A=u[13]/u[15]-o.viewpoint[1],y=u[14]/u[15]-o.viewpoint[2],E=2*w/Math.sqrt(g*g+A*A+y*y)/o.viewport[2];o.currentResolution==E?o.sameResolution=!0:o.sameResolution=!1,o.currentResolution=E},traverse:function(e,t){let r=this;if(r.mesh=e,!e.isReady)return;const o=e.nodesCount;r.visited=new Uint8Array(o),r.blocked=new Uint8Array(o),r.selected=new Uint8Array(o),r.frame=t.frame,r.instance_errors=new Float32Array(o),r.frame>e.frame&&(e.errors=new Float32Array(o),e.frame=r.frame),r.visitQueue=new h(o);for(var s=0;s<e.nroots;s++)r.insertNode(s);r.currentError=t.currentError,r.drawSize=0,r.nblocked=0;for(var i=0;r.visitQueue.size&&r.nblocked<r.maxBlocked;){var n=r.visitQueue.error[0],a=r.visitQueue.pop();0==e.status[a]&&i<t.maxPending&&(t.candidates.push({id:a,mesh:e,frame:r.frame,error:n}),i++);var u=r.blocked[a]||!r.expandNode(a,n);u?r.nblocked++:r.selected[a]=1,r.insertChildren(a,u)}if(t.nodes.has(e))for(let o of t.nodes.get(e)){let t=r.nodeError(o);0==r.instance_errors[o]&&(r.instance_errors[s]=t,e.errors[o]=Math.max(e.errors[o],t))}return r.mesh=null,r.instance_errors},insertNode:function(e){let t=this;t.visited[e]=1;const r=t.nodeError(e);t.instance_errors[e]=r,t.mesh.errors[e]=Math.max(r,t.mesh.errors[e]),t.mesh.frames[e]=t.frame,t.visitQueue.push(e,r)},insertChildren:function(e,t){let r=this;for(let o=r.mesh.nfirstpatch[e];o<r.mesh.nfirstpatch[e+1];++o){const e=r.mesh.patches[3*o];if(e==r.mesh.sink)return;t&&(r.blocked[e]=1),r.visited[e]||r.insertNode(e)}},expandNode:function(e,t){let r=this;if(e>0&&t<r.currentError)return!1;if(r.drawSize>r.drawBudget)return!1;if(1!=r.mesh.status[e])return!1;const o=r.mesh.nspheres,s=5*e;return r.isVisible(o[s],o[s+1],o[s+2],o[s+3])&&(r.drawSize+=.8*r.mesh.nvertices[e]),!0},nodeError:function(e,t){let r=this;const o=r.mesh.nspheres,s=r.viewpoint,i=5*e,n=o[i+0],a=o[i+1],h=o[i+2],u=o[i+3];t&&(u=o[i+4]);const l=s[0]-n,c=s[1]-a,f=s[2]-h;let d=Math.sqrt(l*l+c*c+f*f)-u;d<.1&&(d=.1);let m=r.mesh.nerrors[e]/(r.currentResolution*d),p=r.distance(n,a,h,o[i+4]);return p<-u?m/=101:p<0&&(m/=1-p/u*100),m},distance:function(e,t,r,o){const s=this.planes;let i=1e20;for(let n=0;n<24;n+=4){let a=s[n]*e+s[n+1]*t+s[n+2]*r+s[n+3]+o;a<i&&(i=a)}return i},isVisible:function(e,t,r,o){const s=this.planes;for(let i=0;i<24;i+=4)if(s[i]*e+s[i+1]*t+s[i+2]*r+s[i+3]+o<0)return!1;return!0}};let l=WebGLRenderingContext.prototype,c=[l.NONE,l.BYTE,l.UNSIGNED_BYTE,l.SHORT,l.UNSIGNED_SHORT,l.INT,l.UNSIGNED_INT,l.FLOAT,l.DOUBLE],f=[0,1,1,2,2,4,4,4,8];let d=function(e){var t=this;t.isReady=!1,t.onLoad=[],t.onUpdate=[],t.reqAttempt=0,t.georeq={},t.texreq={},t.frame=0,e&&t.open(e)};d.prototype={open:function(e){let t=this;t.url=e,t.httpRequest(0,88,(function(){console.log("Loading header for "+t.url);let e=new DataView(this.response);e.offset=0,t.reqAttempt++;const r=t.importHeader(e);if(!r)return console.log("Empty header!"),void(t.reqAttempt<maxReqAttempt&&t.open(t.url+"?"+Math.random()));t.reqAttempt=0;for(let e in r)t[e]=r[e];t.vertex=t.signature.vertex,t.face=t.signature.face,t.renderMode=t.face.index?["FILL","POINT"]:["POINT"],t.compressed=6&t.signature.flags,t.meco=2&t.signature.flags,t.corto=4&t.signature.flags,t.requestIndex()}),(function(){console.log("Open request error!")}),(function(){console.log("Open request abort!")}))},httpRequest:function(e,t,r,o,s,i){i||(i="arraybuffer");var n=new XMLHttpRequest;return n.open("GET",this.url,!0),n.responseType=i,n.setRequestHeader("Range","bytes="+e+"-"+(t-1)),n.onload=function(){switch(this.status){case 0:case 206:r.bind(this)()}},n.onerror=o,n.onabort=s,n.send(),n},requestIndex:function(){var e=this,t=88+44*e.nodesCount+12*e.patchesCount+68*e.texturesCount;e.httpRequest(88,t,(function(){console.log("Loading index for "+e.url),e.handleIndex(this.response)}),(function(){console.log("Index request error!")}),(function(){console.log("Index request abort!")}))},handleIndex:function(e){let t=this,r=new DataView(e);r.offset=0;const n=t.nodesCount;t.noffsets=new Uint32Array(n),t.nvertices=new Uint32Array(n),t.nfaces=new Uint32Array(n),t.nerrors=new Float32Array(n),t.nspheres=new Float32Array(5*n),t.nsize=new Float32Array(n),t.nfirstpatch=new Uint32Array(n);for(let e=0;e<n;e++){t.noffsets[e]=256*o(r),t.nvertices[e]=s(r),t.nfaces[e]=s(r),t.nerrors[e]=i(r),r.offset+=8;for(let o=0;o<5;o++)t.nspheres[5*e+o]=i(r);t.nfirstpatch[e]=o(r)}t.sink=n-1,t.patches=new Uint32Array(r.buffer,r.offset,3*t.patchesCount),t.nroots=t.nodesCount;for(let e=0;e<t.nroots;e++)for(let r=t.nfirstpatch[e];r<t.nfirstpatch[e+1];r++)t.patches[3*r]<t.nroots&&(t.nroots=t.patches[3*r]);r.offset+=12*t.patchesCount,t.textures=new Uint32Array(t.texturesCount),t.texref=new Uint32Array(t.texturesCount);for(let e=0;e<t.texturesCount;e++)t.textures[e]=256*o(r),r.offset+=64;t.vsize=12+(t.vertex.normal?6:0)+(t.vertex.color?4:0)+(t.vertex.texCoord?8:0),t.fsize=6;let a=new Uint32Array(n-1),h=new Uint32Array(n-1);for(let e=0;e<n-1;e++){for(let r=t.nfirstpatch[e];r!=t.nfirstpatch[e+1];r++){let o=t.patches[3*r+2];a[e]+=t.textures[o+1]-t.textures[o],h[e]++}t.nsize[e]=t.vsize*t.nvertices[e]+t.fsize*t.nfaces[e]}for(let e=0;e<n-1;e++)t.nsize[e]+=10*a[e]/h[e];t.status=new Uint8Array(n),t.frames=new Uint32Array(n),t.errors=new Float32Array(n),t.reqAttempt=new Uint8Array(n),t.isReady=!0;for(let e of t.onLoad)e(this)},importAttribute:function(e){let t={};return t.type=e.getUint8(e.offset++,!0),t.size=e.getUint8(e.offset++,!0),t.glType=c[t.type],t.normalized=t.type<7,t.stride=f[t.type]*t.size,0==t.size?null:t},importElement:function(e){let t=[];for(let r=0;r<8;r++)t[r]=this.importAttribute(e);return t},importVertex:function(e){const t=this.importElement(e);let r=t[2];return r&&(r.type=2,r.glType=c[2]),{position:t[0],normal:t[1],color:t[2],texCoord:t[3],data:t[4]}},importFace:function(e){const t=this.importElement(e);let r=t[2];return r&&(r.type=2,r.glType=c[2]),{index:t[0],normal:t[1],color:t[2],texCoord:t[3],data:t[4]}},importSignature:function(e){let t={};return t.vertex=this.importVertex(e),t.face=this.importFace(e),t.flags=o(e),t},importHeader:function(e){if(1316516640!=o(e))return null;let t={};return t.version=o(e),t.verticesCount=r(e),t.facesCount=r(e),t.signature=this.importSignature(e),t.nodesCount=o(e),t.patchesCount=o(e),t.texturesCount=o(e),t.sphere={center:[i(e),i(e),i(e)],radius:i(e)},t},createNode:function(e){},createNodeGeometry:function(e,t){},deleteNodeGeometry:function(e){},createTexture:function(e,t){},deleteTexture:function(e){}};function p(){let e=this;e.cortopath=".",e.frame=0,e.maxCacheSize=536870912,e.minFps=15,e.currentFps=0,e.targetError=2,e.currentError=2,e.maxError=15,e.realError=0,e.pending=0,e.maxPending=3,e.cacheSize=0,e.candidates=[],e.nodes=new Map,e.last_frametime=0,e.frametime=0,e.end_frametime=0,e.debug={verbose:!1,nodes:!1,draw:!1,extract:!1},e.totswapped=0,e.swaprate=0,e.lastupdate=performance.now()}function x(e,r,o){if("function"==typeof r)throw"Nexus3D constructor has changed: Nexus3D(url, renderer, options) where options include: onLoad, onUpdate, onProgress and material";t.Object3D.call(this),this.type="NXS",this.url=e,this.gl=r.getContext(),this.material=null,"material"in o&&(this.material=o.material),this.material||(this.material=new t.MeshStandardMaterial);for(let e of["onLoad","onUpdate","onProgress"])this[e]=[],e in o&&this[e].push(o[e]);this.autoUpdate=!0,this.mesh=new d,this.vbo=[],this.ibo=[],this.textures=[],this.attributes={},this.basemesh=null,this.url&&("object"==typeof e?(this.nxs=this.url,this.nxs.onLoad.push((e=>{this.mesh=this.nxs.mesh,this.traversal=this.nxs.traversal,this.cache=this.nxs.cache,this.vbo=this.nxs.vbo,this.ibo=this.nxs.ibo,this.textures=this.nxs.textures,this.onLoadCallback(this)}))):this.open(this.url))}p.prototype={getTargetError:function(){return this.targetError},getMinFps:function(){return this.minFps},setMinFps:function(e){this.minFps=e},getMaxCacheSize:function(){return this.maxCacheSize},setMaxCacheSize:function(e){this.maxCacheSize=e},setTargetError:function(e){this.targetError=e},loadCorto:function(){let e=new Worker(this.cortopath+"/corto.em.js");e.requests={},e.count=0,e.postRequest=function(t){e.postMessage({buffer:t.buffer,request:this.count,rgba_colors:!0,short_index:!0,short_normals:!0}),t.buffer=null,this.requests[this.count++]=t},e.onmessage=function(e){var t=e.data.request,r=this.requests[t];delete this.requests[t],r.model=e.data.model,r.cache.readyGeometryNode(r.mesh,r.id,r.model)},this.corto=e},beginFrame:function(e){let t=this;t.frametime=performance.now();let r=t.frametime-t.last_frametime;if(t.last_frametime=t.frametime,r<500&&(t.currentFps=.9*t.currentFps+1e3/r*.1),e=t.currentFps,t.frame++,t.candidates=[],e&&t.minFps){t.currentFps=e;const r=t.minFps/e;r>1.1&&(t.currentError*=1.05),r<.9&&(t.currentError*=.95),t.currentError=Math.max(t.targetError,Math.min(t.maxError,t.currentError))}else t.currentError=t.targetError;t.rendered=0,t.realError=1e20,t.totswapped=0},endFrame:function(){this.update()},requestNode:function(e,t){e.status[t]=2,this.pending++,this.cacheSize+=e.nsize[t],e.reqAttempt[t]=0,this.requestNodeGeometry(e,t),this.requestNodeTexture(e,t)},requestNodeGeometry:function(e,t){let r=this;e.status[t]++,e.georeq[t]=e.httpRequest(e.noffsets[t],e.noffsets[t+1],(function(){delete e.texreq[t],r.loadNodeGeometry(this,e,t)}),(function(){delete e.texreq[t],this.debug.verbose&&console.log("Geometry request error!"),r.recoverNode(e,t,0)}),(function(){delete e.texreq[t],this.debug.verbose&&console.log("Geometry request abort!"),r.removeNode(e,t)}),"arraybuffer")},requestNodeTexture:function(e,t){let r=this;if(!e.vertex.texCoord)return;let o=e.patches[3*e.nfirstpatch[t]+2];e.texref[o]++,e.status[t]++,e.texreq[o]=e.httpRequest(e.textures[o],e.textures[o+1],(function(){delete e.texreq[o],r.loadNodeTexture(this,e,t,o)}),(function(){delete e.texreq[o],this.debug.verbose&&console.log("Texture request error!"),r.recoverNode(e,t,1)}),(function(){delete e.texreq[o],this.debug.verbose&&console.log("Texture request abort!"),r.removeNode(e,t)}),"blob")},recoverNode:function(e,t,r){if(0==e.status[t])return;e.status[t]--;let o=this;if(e.reqAttempt[t]>2)return this.debug.verbose&&console.log("Max request limit for "+m.url+" node: "+n),void o.removeNode(e,t);switch(e.reqAttempt[t]++,r){case 0:o.requestNodeGeometry(e,t),this.debug.verbose&&console.log("Recovering geometry for "+m.url+" node: "+n);break;case 1:o.requestNodeTexture(e,t),this.debug.verbose&&console.log("Recovering texture for "+m.url+" node: "+n)}},loadNodeGeometry:function(e,t,r){0!=t.status[r]&&(t.compressed?(this.corto||this.loadCorto(),this.corto.postRequest({mesh:t,id:r,buffer:e.response,cache:this})):this.readyGeometryNode(t,r,e.response))},loadNodeTexture:function(e,t,r,o){if(0==t.status[r])throw"Should not load texture twice";let s=e.response,i=e=>{0!=t.status[r]&&(t.createTexture(o,e),t.status[r]--,2==t.status[r]&&this.readyNode(t,r))};if("undefined"!=typeof createImageBitmap){"undefined"!=typeof InstallTrigger?createImageBitmap(s).then(i):createImageBitmap(s,{imageOrientation:"flipY"}).then(i)}else{var n=window.URL||window.webkitURL,a=document.createElement("img");a.onerror=function(e){console.log("Texture loading error!")},a.src=n.createObjectURL(s),a.onload=function(){n.revokeObjectURL(a.src),i(a)}}},removeNode:function(e,t){if(this.nodes.get(e).delete(t),0==e.status[t])throw"Was already removed!";if(e.status[t]=0,t in e.georeq&&4!=e.georeq[t].readyState&&(e.georeq[t].abort(),delete e.georeq[t],this.pending--),this.cacheSize-=e.nsize[t],e.deleteNodeGeometry(t),!e.vertex.texCoord)return;const r=e.patches[3*e.nfirstpatch[t]+2];r in e.texreq&&4!=e.texreq[r].readyState&&(e.texreq[r].abort(),delete e.texreq[r]),e.texref[r]--,0==e.texref[r]&&e.deleteTexture(r)},readyGeometryNode:function(e,t,r){if(0==e.status[t])return;const o=e.nvertices[t],s=e.nfaces[t];let i={};if(e.corto)i=r;else{i.index=new Uint16Array(r,o*e.vsize,3*s),i.position=new Float32Array(r,0,3*o);var n=12*o;e.vertex.texCoord&&(i.uv=new Float32Array(r,n,2*o),n+=8*o),e.vertex.normal&&(i.normal=new Int16Array(r,n,3*o),n+=6*o),e.vertex.color&&(i.color=new Uint8Array(r,n,4*o),n+=4*o)}e.createNodeGeometry(t,i),e.status[t]--,2==e.status[t]&&this.readyNode(e,t)},readyNode:function(e,t){if(this.nodes.has(e)||this.nodes.set(e,new Set),this.nodes.get(e).add(t),e.status[t]--,1!=e.status[t])throw"A ready node should have status ==1";e.reqAttempt[t]=0,this.pending--,e.createNode(t);for(let t of e.onUpdate)t();this.update()},flush:function(e){for(let t of this.nodes.get(e))this.removeNode(e,t);this.nodes.delete(e)},update:function(){if(this.pending>=3)return;let e=null;for(let t of this.candidates)0==t.mesh.status[t.id]&&(!e||t.error>e.error)&&(e=t);if(e){for(;this.cacheSize>this.maxCacheSize;){let t=null;for(let[e,r]of this.nodes)for(let o of r){let r=e.errors[o],s=e.frames[o];(!t||r<t.error)&&(t={id:o,frame:s,error:r,mesh:e})}if(!t||t.error>=.9*e.error)return;this.removeNode(t.mesh,t.id)}this.totswapped+=e.mesh.nsize[e.id],this.candidates=this.candidates.filter((t=>t.mesh==e.mesh&&t.id==e.id)),this.requestNode(e.mesh,e.id),this.update()}}},x.prototype=Object.assign(Object.create(t.Object3D.prototype),{constructor:x,isNXS:!0,copy:function(e){throw Object3D.prototype.copy.call(this,e,!1),"Can't really copy."},open:function(e){let t=this;this.mesh.open(e),this.mesh.createNode=e=>{},this.mesh.createNodeGeometry=(e,r)=>{t.createNodeGeometry(e,r)},this.mesh.createTexture=(e,r)=>{t.createTexture(e,r)},this.mesh.deleteNodeGeometry=e=>{t.deleteNodeGeometry(e)},this.mesh.deleteTexture=e=>{t.deleteTexture(e)},this.mesh.onLoad.push((()=>{t.onLoadCallback()})),this.mesh.onUpdate.push((()=>{for(let e of t.onUpdate)e(this)})),this.traversal=new u,this.cache=new p,this.textures={}},set onLoad(e){this.onLoad.push(e)},set onUpdate(e){this.onLoad.push(e)},set onProgress(e){this.onProgress.push(e)},set material(e){this.cube.material=this.material=e,this.material.needsUpdate=!0},updateMaterials:function(){!1!==this.material.map&&this.mesh.vertex.texCoord&&(this.material.map=this.cube_texture),this.mesh.vertex.color&&(this.material.vertexColors=t.VertexColors),this.material.needsUpdate=!0},onLoadCallback:function(){const e=this.mesh.sphere.center,r=new t.Vector3(e[0],e[1],e[2]),o=this.mesh.sphere.radius;this.boundingSphere=new t.Sphere(r,o);var s=new t.BufferGeometry;s.setAttribute("position",new t.BufferAttribute(new Float32Array(3),3)),this.mesh.vertex.normal&&s.setAttribute("normal",new t.BufferAttribute(new Float32Array(3),3)),this.mesh.vertex.color&&s.setAttribute("color",new t.BufferAttribute(new Float32Array(4),4)),this.mesh.vertex.texCoord&&s.setAttribute("uv",new t.BufferAttribute(new Float32Array(2),2)),this.cube_texture=new t.DataTexture(new Uint8Array([1,1,1]),1,1,t.RGBFormat),this.cube_texture.needsUpdate=!0,this.updateMaterials();let i=new t.Mesh(s,this.material);i.frustumCulled=!1,i.onBeforeRender=(e,t,r,o,s,i)=>{this.onBeforeRender(e,t,r,o,s,i)},i.onAfterRender=(e,t,r,o,s,i)=>{this.onAfterRender(e,t,r,o,s,i)},this.add(i);for(let e of this.onLoad)e(this)},onBeforeRender:function(e,t,r,o,s,i){},onAfterRender:function(e,r,o,s,i,n){let a=new t.Vector2;if(e.getSize(a),this.modelViewMatrix.multiplyMatrices(o.matrixWorldInverse,this.matrixWorld),this.traversal.updateView([0,0,a.width,a.height],o.projectionMatrix.elements,this.modelViewMatrix.elements),this.instance_errors=this.traversal.traverse(this.mesh,this.cache),this.material.version>0){this.updateMaterials(),this.material.version=0;for(let e of this.onUpdate)e(this);let e=this.gl;var h=e.getParameter(e.CURRENT_PROGRAM),u=this.attributes;u.position=e.getAttribLocation(h,"position"),u.normal=e.getAttribLocation(h,"normal"),u.color=e.getAttribLocation(h,"color"),u.uv=e.getAttribLocation(h,"uv"),u.size=e.getUniformLocation(h,"size"),u.scale=e.getUniformLocation(h,"scale");let t=e.getUniformLocation(h,"map");u.map=t?e.getUniform(h,t):null}this.setVisibility()},setVisibility:function(){let e=this.traversal,t=this.mesh;if(!t.isReady)return;let r=0;for(let c=0;c<t.nodesCount;c++){if(!e.selected[c])continue;{let r=!1;t.nfirstpatch[c+1];for(var o=t.nfirstpatch[c];o<t.nfirstpatch[c+1];++o){var s=t.patches[3*o];if(!e.selected[s]){r=!0;break}}if(!r)continue}var i=t.nspheres,n=5*c;if(!e.isVisible(i[n],i[n+1],i[n+2],i[n+4]))continue;let f=this.attributes,d=this.mesh,m=this.gl;m.bindBuffer(m.ARRAY_BUFFER,this.vbo[c]),m.bindBuffer(m.ELEMENT_ARRAY_BUFFER,this.ibo[c]),m.vertexAttribPointer(f.position,3,m.FLOAT,!1,12,0),m.enableVertexAttribArray(f.position);let p=this.mesh.nvertices[c],x=12*p;if(d.vertex.texCoord&&(f.uv>=0&&(m.vertexAttribPointer(f.uv,2,m.FLOAT,!1,8,x),m.enableVertexAttribArray(f.uv)),x+=8*p),d.vertex.color&&(f.color>=0&&(m.vertexAttribPointer(f.color,4,m.UNSIGNED_BYTE,!0,4,x),m.enableVertexAttribArray(f.color)),x+=4*p),d.vertex.normal&&f.normal>=0&&(m.vertexAttribPointer(f.normal,3,m.SHORT,!0,6,x),m.enableVertexAttribArray(f.normal)),this.cache.debug.nodes){m.disableVertexAttribArray(f.color);var a=this.instance_errors[c],h=[[1,1,1,1],[1,1,1,1],[0,1,0,1],[0,1,1,1],[1,1,0,1],[1,0,1,1],[1,0,0,1]];let e=Math.min(5.99,Math.max(0,Math.log2(a)/2)),t=Math.floor(e);e-=t;let r=[];for(let o=0;o<4;o++)r[o]=h[t][o]*(1-e)+h[t+1][o]*e;m.vertexAttrib4fv(f.color,r)}this.cache.realError=Math.min(this.mesh.errors[c],this.cache.realError),x=0;let v=0,b=t.nfirstpatch[c+1]-1;for(let o=t.nfirstpatch[c];o<t.nfirstpatch[c+1];++o){let s=t.patches[3*o];if(e.selected[s]||(v=t.patches[3*o+1],!(o<b))){if(v>x){if(t.vertex.texCoord&&f.uv>=0){var u=t.patches[3*o+2];if(-1!=u){var l=this.textures[u];m.activeTexture(m.TEXTURE0+f.map),m.bindTexture(m.TEXTURE_2D,l)}}m.drawElements(m.TRIANGLES,3*(v-x),m.UNSIGNED_SHORT,6*x),r+=v-x}x=t.patches[3*o+1]}}}this.cache.rendered+=r},createNodeGeometry:function(e,r){let o=this.mesh;var s=o.nvertices[e];o.nfaces[e];let i=r.index,n=new ArrayBuffer(s*o.vsize);new Float32Array(n,0,3*s).set(r.position);var a=12*s;o.vertex.texCoord&&(new Float32Array(n,a,2*s).set(r.uv),a+=8*s);o.vertex.color&&(new Uint8Array(n,a,4*s).set(r.color),a+=4*s);o.vertex.normal&&(new Int16Array(n,a,3*s).set(r.normal),a+=6*s);if(e<this.mesh.nroots){let e=new t.BufferGeometry;e.setAttribute("position",new t.BufferAttribute(r.position,3)),e.setAttribute("normal",new t.BufferAttribute(r.normal,3)),e.setIndex(new t.BufferAttribute(r.index,1)),this.basemesh=new t.Mesh(e,this.material),this.basemesh.visible=!1,this.add(this.basemesh)}var h=this.gl,u=this.vbo[e]=h.createBuffer();h.bindBuffer(h.ARRAY_BUFFER,u),h.bufferData(h.ARRAY_BUFFER,n,h.STATIC_DRAW);var l=this.ibo[e]=h.createBuffer();h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,l),h.bufferData(h.ELEMENT_ARRAY_BUFFER,i,h.STATIC_DRAW)},createTexture:function(e,t){let r=this.gl;var o=r.getParameter(r.UNPACK_FLIP_Y_WEBGL);r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,!0);let s=this.textures[e]=r.createTexture();r.bindTexture(r.TEXTURE_2D,s);r.texImage2D(r.TEXTURE_2D,0,r.RGB,r.RGB,r.UNSIGNED_BYTE,t);function i(e){return e&&0==(e&e-1)}r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.LINEAR),!(r instanceof WebGLRenderingContext)||i(t.width)&&i(t.height)?(r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.NEAREST_MIPMAP_LINEAR),r.generateMipmap(r.TEXTURE_2D)):r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR),r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,o)},deleteNodeGeometry:function(e){this.gl.deleteBuffer(this.vbo[e]),this.gl.deleteBuffer(this.ibo[e]),this.vbo[e]=this.ibo[e]=null},deleteTexture:function(e){if(!this.textures[e])throw"Deleting missing texture!";this.gl.deleteTexture(this.textures[e]),this.textures[e]=0},toJSON:function(e){throw"Can't"}}),e.Nexus3D=x,Object.defineProperty(e,"__esModule",{value:!0})}));
