!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("three")):"function"==typeof define&&define.amd?define(["exports","three"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).Nexus3D={},e.THREE)}(this,(function(e,t){"use strict";function r(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach((function(r){if("default"!==r){var o=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(t,r,o.get?o:{enumerable:!0,get:function(){return e[r]}})}})),t.default=e,Object.freeze(t)}var o=r(t);function s(e){var t=e.getUint32(e.offset,!0),r=e.getUint32(e.offset+4,!0);return e.offset+=8,1*r+t}function i(e){var t=e.getUint32(e.offset,!0);return e.offset+=4,t}function a(e){var t=e.getUint16(e.offset,!0);return e.offset+=2,t}function h(e){var t=e.getFloat32(e.offset,!0);return e.offset+=4,t}function l(e,t){var r=1/(e[12]*e[9]*e[6]*e[3]-e[8]*e[13]*e[6]*e[3]-e[12]*e[5]*e[10]*e[3]+e[4]*e[13]*e[10]*e[3]+e[8]*e[5]*e[14]*e[3]-e[4]*e[9]*e[14]*e[3]-e[12]*e[9]*e[2]*e[7]+e[8]*e[13]*e[2]*e[7]+e[12]*e[1]*e[10]*e[7]-e[0]*e[13]*e[10]*e[7]-e[8]*e[1]*e[14]*e[7]+e[0]*e[9]*e[14]*e[7]+e[12]*e[5]*e[2]*e[11]-e[4]*e[13]*e[2]*e[11]-e[12]*e[1]*e[6]*e[11]+e[0]*e[13]*e[6]*e[11]+e[4]*e[1]*e[14]*e[11]-e[0]*e[5]*e[14]*e[11]-e[8]*e[5]*e[2]*e[15]+e[4]*e[9]*e[2]*e[15]+e[8]*e[1]*e[6]*e[15]-e[0]*e[9]*e[6]*e[15]-e[4]*e[1]*e[10]*e[15]+e[0]*e[5]*e[10]*e[15]);t[0]=(e[9]*e[14]*e[7]-e[13]*e[10]*e[7]+e[13]*e[6]*e[11]-e[5]*e[14]*e[11]-e[9]*e[6]*e[15]+e[5]*e[10]*e[15])*r,t[1]=(e[13]*e[10]*e[3]-e[9]*e[14]*e[3]-e[13]*e[2]*e[11]+e[1]*e[14]*e[11]+e[9]*e[2]*e[15]-e[1]*e[10]*e[15])*r,t[2]=(e[5]*e[14]*e[3]-e[13]*e[6]*e[3]+e[13]*e[2]*e[7]-e[1]*e[14]*e[7]-e[5]*e[2]*e[15]+e[1]*e[6]*e[15])*r,t[3]=(e[9]*e[6]*e[3]-e[5]*e[10]*e[3]-e[9]*e[2]*e[7]+e[1]*e[10]*e[7]+e[5]*e[2]*e[11]-e[1]*e[6]*e[11])*r,t[4]=(e[12]*e[10]*e[7]-e[8]*e[14]*e[7]-e[12]*e[6]*e[11]+e[4]*e[14]*e[11]+e[8]*e[6]*e[15]-e[4]*e[10]*e[15])*r,t[5]=(e[8]*e[14]*e[3]-e[12]*e[10]*e[3]+e[12]*e[2]*e[11]-e[0]*e[14]*e[11]-e[8]*e[2]*e[15]+e[0]*e[10]*e[15])*r,t[6]=(e[12]*e[6]*e[3]-e[4]*e[14]*e[3]-e[12]*e[2]*e[7]+e[0]*e[14]*e[7]+e[4]*e[2]*e[15]-e[0]*e[6]*e[15])*r,t[7]=(e[4]*e[10]*e[3]-e[8]*e[6]*e[3]+e[8]*e[2]*e[7]-e[0]*e[10]*e[7]-e[4]*e[2]*e[11]+e[0]*e[6]*e[11])*r,t[8]=(e[8]*e[13]*e[7]-e[12]*e[9]*e[7]+e[12]*e[5]*e[11]-e[4]*e[13]*e[11]-e[8]*e[5]*e[15]+e[4]*e[9]*e[15])*r,t[9]=(e[12]*e[9]*e[3]-e[8]*e[13]*e[3]-e[12]*e[1]*e[11]+e[0]*e[13]*e[11]+e[8]*e[1]*e[15]-e[0]*e[9]*e[15])*r,t[10]=(e[4]*e[13]*e[3]-e[12]*e[5]*e[3]+e[12]*e[1]*e[7]-e[0]*e[13]*e[7]-e[4]*e[1]*e[15]+e[0]*e[5]*e[15])*r,t[11]=(e[8]*e[5]*e[3]-e[4]*e[9]*e[3]-e[8]*e[1]*e[7]+e[0]*e[9]*e[7]+e[4]*e[1]*e[11]-e[0]*e[5]*e[11])*r,t[12]=(e[12]*e[9]*e[6]-e[8]*e[13]*e[6]-e[12]*e[5]*e[10]+e[4]*e[13]*e[10]+e[8]*e[5]*e[14]-e[4]*e[9]*e[14])*r,t[13]=(e[8]*e[13]*e[2]-e[12]*e[9]*e[2]+e[12]*e[1]*e[10]-e[0]*e[13]*e[10]-e[8]*e[1]*e[14]+e[0]*e[9]*e[14])*r,t[14]=(e[12]*e[5]*e[2]-e[4]*e[13]*e[2]-e[12]*e[1]*e[6]+e[0]*e[13]*e[6]+e[4]*e[1]*e[14]-e[0]*e[5]*e[14])*r,t[15]=(e[4]*e[9]*e[2]-e[8]*e[5]*e[2]+e[8]*e[1]*e[6]-e[0]*e[9]*e[6]-e[4]*e[1]*e[10]+e[0]*e[5]*e[10])*r}function u(e){this.error=new Float32Array(e),this.data=new Int32Array(e),this.size=0}function d(){let e=this;e.maxBlocked=30,e.modelMatrix=new Float32Array(16),e.viewMatrix=new Float32Array(16),e.projectionMatrix=new Float32Array(16),e.modelView=new Float32Array(16),e.modelViewInv=new Float32Array(16),e.modelViewProj=new Float32Array(16),e.modelViewProjInv=new Float32Array(16),e.planes=new Float32Array(24),e.viewport=new Float32Array(4),e.viewpoint=new Float32Array(4)}u.prototype={push:function(e,t){this.data[this.size]=e,this.error[this.size]=t,this.bubbleUp(this.size),this.size++},pop:function(){var e=this.data[0];return this.size--,this.size>0&&(this.data[0]=this.data[this.size],this.error[0]=this.error[this.size],this.sinkDown(0)),e},bubbleUp:function(e){for(var t=this.data[e],r=this.error[e];e>0;){var o=(e+1>>1)-1,s=this.error[o];if(s>r)break;this.data[e]=this.data[o],this.error[e]=s,this.data[o]=t,this.error[o]=r,e=o}},sinkDown:function(e){for(var t=this.data[e],r=this.error[e];;){var o=2*(e+1),s=o-1,i=-1;if(s<this.size){var n=this.error[s];n>r&&(i=s)}if(o<this.size)this.error[o]>(-1==i?r:n)&&(i=o);if(-1==i)break;this.data[e]=this.data[i],this.error[e]=this.error[i],this.data[i]=t,this.error[i]=r,e=i}}},d.prototype={updateView:function(e,t,r){let o=this;for(let e=0;e<16;e++)o.projectionMatrix[e]=t[e],o.modelView[e]=r[e];for(let t=0;t<4;t++)o.viewport[t]=e[t];var s,i,n;s=o.projectionMatrix,i=o.modelView,(n=o.modelViewProj)[0]=s[0]*i[0]+s[4]*i[1]+s[8]*i[2]+s[12]*i[3],n[1]=s[1]*i[0]+s[5]*i[1]+s[9]*i[2]+s[13]*i[3],n[2]=s[2]*i[0]+s[6]*i[1]+s[10]*i[2]+s[14]*i[3],n[3]=s[3]*i[0]+s[7]*i[1]+s[11]*i[2]+s[15]*i[3],n[4]=s[0]*i[4]+s[4]*i[5]+s[8]*i[6]+s[12]*i[7],n[5]=s[1]*i[4]+s[5]*i[5]+s[9]*i[6]+s[13]*i[7],n[6]=s[2]*i[4]+s[6]*i[5]+s[10]*i[6]+s[14]*i[7],n[7]=s[3]*i[4]+s[7]*i[5]+s[11]*i[6]+s[15]*i[7],n[8]=s[0]*i[8]+s[4]*i[9]+s[8]*i[10]+s[12]*i[11],n[9]=s[1]*i[8]+s[5]*i[9]+s[9]*i[10]+s[13]*i[11],n[10]=s[2]*i[8]+s[6]*i[9]+s[10]*i[10]+s[14]*i[11],n[11]=s[3]*i[8]+s[7]*i[9]+s[11]*i[10]+s[15]*i[11],n[12]=s[0]*i[12]+s[4]*i[13]+s[8]*i[14]+s[12]*i[15],n[13]=s[1]*i[12]+s[5]*i[13]+s[9]*i[14]+s[13]*i[15],n[14]=s[2]*i[12]+s[6]*i[13]+s[10]*i[14]+s[14]*i[15],n[15]=s[3]*i[12]+s[7]*i[13]+s[11]*i[14]+s[15]*i[15],l(o.modelViewProj,o.modelViewProjInv),l(o.modelView,o.modelViewInv),o.viewpoint[0]=o.modelViewInv[12],o.viewpoint[1]=o.modelViewInv[13],o.viewpoint[2]=o.modelViewInv[14],o.viewpoint[3]=1;const a=o.modelViewProj,h=o.modelViewProjInv;let u=o.planes;u[0]=a[0]+a[3],u[1]=a[4]+a[7],u[2]=a[8]+a[11],u[3]=a[12]+a[15],u[4]=-a[0]+a[3],u[5]=-a[4]+a[7],u[6]=-a[8]+a[11],u[7]=-a[12]+a[15],u[8]=a[1]+a[3],u[9]=a[5]+a[7],u[10]=a[9]+a[11],u[11]=a[13]+a[15],u[12]=-a[1]+a[3],u[13]=-a[5]+a[7],u[14]=-a[9]+a[11],u[15]=-a[13]+a[15],u[16]=-a[2]+a[3],u[17]=-a[6]+a[7],u[18]=-a[10]+a[11],u[19]=-a[14]+a[15],u[20]=-a[2]+a[3],u[21]=-a[6]+a[7],u[22]=-a[10]+a[11],u[23]=-a[14]+a[15];for(let e=0;e<24;e+=4){let t=Math.sqrt(u[e]*u[e]+u[e+1]*u[e+1]+u[e+2]*u[e+2]);u[e]/=t,u[e+1]/=t,u[e+2]/=t,u[e+3]/=t}const d=h[3]+h[15],c=(h[0]+h[12])/d,f=(h[1]+h[13])/d,m=(h[2]+h[14])/d,p=-h[3]+h[15],x=(-h[0]+h[12])/p-c,v=(-h[1]+h[13])/p-f,b=(-h[2]+h[14])/p-m,g=Math.sqrt(x*x+v*v+b*b),w=h[12]/h[15]-o.viewpoint[0],y=h[13]/h[15]-o.viewpoint[1],A=h[14]/h[15]-o.viewpoint[2],E=2*g/Math.sqrt(w*w+y*y+A*A)/o.viewport[2];o.currentResolution==E?o.sameResolution=!0:o.sameResolution=!1,o.currentResolution=E},traverse:function(e,t){let r=this;if(r.mesh=e,!e.isReady)return;const o=e.nodesCount;r.visited=new Uint8Array(o),r.blocked=new Uint8Array(o),r.selected=new Uint8Array(o),r.frame=t.frame,r.instance_errors=new Float32Array(o),r.frame>e.frame&&(e.errors=new Float32Array(o),e.frame=r.frame),r.visitQueue=new u(o);for(var s=0;s<e.nroots;s++)r.insertNode(s);r.currentError=t.currentError,r.drawSize=0,r.nblocked=0;for(var i=0;r.visitQueue.size&&r.nblocked<r.maxBlocked;){var n=r.visitQueue.error[0],a=r.visitQueue.pop();0==e.status[a]&&i<t.maxPending&&(t.candidates.push({id:a,mesh:e,frame:r.frame,error:n}),i++);var h=r.blocked[a]||!r.expandNode(a,n);h?r.nblocked++:r.selected[a]=1,r.insertChildren(a,h)}if(t.nodes.has(e))for(let o of t.nodes.get(e)){let t=r.nodeError(o);0==r.instance_errors[o]&&(r.instance_errors[s]=t,e.errors[o]=Math.max(e.errors[o],t))}return r.mesh=null,r.instance_errors},insertNode:function(e){let t=this;t.visited[e]=1;const r=t.nodeError(e);t.instance_errors[e]=r,t.mesh.errors[e]=Math.max(r,t.mesh.errors[e]),t.mesh.frames[e]=t.frame,t.visitQueue.push(e,r)},insertChildren:function(e,t){let r=this;for(let o=r.mesh.nfirstpatch[e];o<r.mesh.nfirstpatch[e+1];++o){const e=r.mesh.patches[3*o];if(e==r.mesh.sink)return;t&&(r.blocked[e]=1),r.visited[e]||r.insertNode(e)}},expandNode:function(e,t){let r=this;if(e>0&&t<r.currentError)return!1;if(r.drawSize>r.drawBudget)return!1;if(1!=r.mesh.status[e])return!1;const o=r.mesh.nspheres,s=5*e;return r.isVisible(o[s],o[s+1],o[s+2],o[s+3])&&(r.drawSize+=.8*r.mesh.nvertices[e]),!0},nodeError:function(e,t){let r=this;const o=r.mesh.nspheres,s=r.viewpoint,i=5*e,n=o[i+0],a=o[i+1],h=o[i+2];let l=o[i+3];t&&(l=o[i+4]);const u=s[0]-n,d=s[1]-a,c=s[2]-h;let f=Math.sqrt(u*u+d*d+c*c)-l;f<.1&&(f=.1);let m=r.mesh.nerrors[e]/(r.currentResolution*f),p=r.distance(n,a,h,o[i+4]);return p<-l?m/=101:p<0&&(m/=1-p/l*100),m},distance:function(e,t,r,o){const s=this.planes;let i=1e20;for(let n=0;n<24;n+=4){let a=s[n]*e+s[n+1]*t+s[n+2]*r+s[n+3]+o;a<i&&(i=a)}return i},isVisible:function(e,t,r,o){const s=this.planes;for(let i=0;i<24;i+=4)if(s[i]*e+s[i+1]*t+s[i+2]*r+s[i+3]+o<0)return!1;return!0}};let c=WebGLRenderingContext.prototype,f=[c.NONE,c.BYTE,c.UNSIGNED_BYTE,c.SHORT,c.UNSIGNED_SHORT,c.INT,c.UNSIGNED_INT,c.FLOAT,c.DOUBLE],p=[0,1,1,2,2,4,4,4,8];let x=function(e){var t=this;t.isReady=!1,t.onLoad=[],t.onUpdate=[],t.reqAttempt=0,t.georeq={},t.texreq={},t.frame=0,t.availableNodes=0,e&&t.open(e)};x.prototype={open:function(e){let t=this;t.url=e,t.httpRequest(e,0,88,(function(){console.log("Loading header for "+t.url);let r=new DataView(this.response);r.offset=0,t.reqAttempt++;const o=t.importHeader(r);if(!o)return console.log("Empty header!"),void(t.reqAttempt<maxReqAttempt&&t.open(t.url+"?"+Math.random()));t.reqAttempt=0;for(let e in o)t[e]=o[e];t.vertex=t.signature.vertex,t.face=t.signature.face,t.renderMode=t.face.index?["FILL","POINT"]:["POINT"],t.compressed=6&t.signature.flags,t.meco=2&t.signature.flags,t.corto=4&t.signature.flags,t.deepzoom=8&t.signature.flags,t.deepzoom&&(t.baseurl=e.substr(0,e.length-4)+"_files/"),t.requestIndex()}),(function(){console.log("Open request error!")}),(function(){console.log("Open request abort!")}))},httpRequest:function(e,t,r,o,s,i,n){n||(n="arraybuffer");var a=new XMLHttpRequest;return a.open("GET",e,!0),a.responseType=n,r&&a.setRequestHeader("Range","bytes="+t+"-"+(r-1)),a.onload=function(){switch(this.status){case 0:s();break;case 206:o.bind(this)();break;case 200:0==r?o.bind(this)():s()}},a.onerror=s,a.onabort=i,a.send(),a},requestIndex:function(){var e=this,t=88+44*e.nodesCount+12*e.patchesCount+68*e.texturesCount;e.httpRequest(this.url,88,t,(function(){console.log("Loading index for "+e.url),e.handleIndex(this.response)}),(function(){console.log("Index request error!")}),(function(){console.log("Index request abort!")}))},handleIndex:function(e){let t=this,r=new DataView(e);r.offset=0;const o=t.nodesCount;t.noffsets=new Uint32Array(o),t.nvertices=new Uint32Array(o),t.nfaces=new Uint32Array(o),t.nerrors=new Float32Array(o),t.nspheres=new Float32Array(5*o),t.nsize=new Float32Array(o),t.nfirstpatch=new Uint32Array(o);for(let e=0;e<o;e++){t.noffsets[e]=256*i(r),t.nvertices[e]=a(r),t.nfaces[e]=a(r),t.nerrors[e]=h(r),r.offset+=8;for(let o=0;o<5;o++)t.nspheres[5*e+o]=h(r);t.nfirstpatch[e]=i(r)}t.sink=o-1,t.patches=new Uint32Array(r.buffer,r.offset,3*t.patchesCount),t.nroots=t.nodesCount;for(let e=0;e<t.nroots;e++)for(let r=t.nfirstpatch[e];r<t.nfirstpatch[e+1];r++)t.patches[3*r]<t.nroots&&(t.nroots=t.patches[3*r]);r.offset+=12*t.patchesCount,t.textures=new Uint32Array(t.texturesCount),t.texref=new Uint32Array(t.texturesCount);for(let e=0;e<t.texturesCount;e++)t.textures[e]=256*i(r),r.offset+=64;t.vsize=12+(t.vertex.normal?6:0)+(t.vertex.color?4:0)+(t.vertex.texCoord?8:0),t.fsize=6;let s=new Uint32Array(o-1),n=new Uint32Array(o-1);for(let e=0;e<o-1;e++){for(let r=t.nfirstpatch[e];r!=t.nfirstpatch[e+1];r++){let o=t.patches[3*r+2];s[e]+=t.textures[o+1]-t.textures[o],n[e]++}t.nsize[e]=t.vsize*t.nvertices[e]+t.fsize*t.nfaces[e]}for(let e=0;e<o-1;e++)t.nsize[e]+=10*s[e]/n[e];t.status=new Uint8Array(o),t.frames=new Uint32Array(o),t.errors=new Float32Array(o),t.reqAttempt=new Uint8Array(o),t.isReady=!0;for(let e of t.onLoad)e(this)},importAttribute:function(e){let t={};return t.type=e.getUint8(e.offset++,!0),t.size=e.getUint8(e.offset++,!0),t.glType=f[t.type],t.normalized=t.type<7,t.stride=p[t.type]*t.size,0==t.size?null:t},importElement:function(e){let t=[];for(let r=0;r<8;r++)t[r]=this.importAttribute(e);return t},importVertex:function(e){const t=this.importElement(e);let r=t[2];return r&&(r.type=2,r.glType=f[2]),{position:t[0],normal:t[1],color:t[2],texCoord:t[3],data:t[4]}},importFace:function(e){const t=this.importElement(e);let r=t[2];return r&&(r.type=2,r.glType=f[2]),{index:t[0],normal:t[1],color:t[2],texCoord:t[3],data:t[4]}},importSignature:function(e){let t={};return t.vertex=this.importVertex(e),t.face=this.importFace(e),t.flags=i(e),t},importHeader:function(e){if(1316516640!=i(e))return null;let t={};return t.version=i(e),t.verticesCount=s(e),t.facesCount=s(e),t.signature=this.importSignature(e),t.nodesCount=i(e),t.patchesCount=i(e),t.texturesCount=i(e),t.sphere={center:[h(e),h(e),h(e)],radius:h(e)},t},createNode:function(e){},createNodeGeometry:function(e,t){},deleteNodeGeometry:function(e){},createTexture:function(e,t){},deleteTexture:function(e){}};function v(){let e=this;e.cortopath=".",e.frame=0,e.maxCacheSize=1073741824,e.minFps=15,e.currentFps=0,e.targetError=2,e.currentError=2,e.maxError=15,e.realError=0,e.pending=0,e.maxPending=3,e.cacheSize=0,e.candidates=[],e.nodes=new Map,e.last_frametime=0,e.frametime=0,e.end_frametime=0,e.debug={verbose:!1,nodes:!1,draw:!1,extract:!1},e.totswapped=0,e.swaprate=0,e.lastupdate=performance.now()}v.prototype={getTargetError:function(){return this.targetError},getMinFps:function(){return this.minFps},setMinFps:function(e){this.minFps=e},getMaxCacheSize:function(){return this.maxCacheSize},setMaxCacheSize:function(e){this.maxCacheSize=e},setTargetError:function(e){this.targetError=e},loadCorto:function(){let e=new Worker(this.cortopath+"/corto.em.js");e.requests={},e.count=0,e.postRequest=function(t){e.postMessage({buffer:t.buffer,request:this.count,rgba_colors:!0,short_index:!0,short_normals:!0}),t.buffer=null,this.requests[this.count++]=t},e.onmessage=function(e){var t=e.data.request,r=this.requests[t];delete this.requests[t],r.model=e.data.model,r.cache.readyGeometryNode(r.mesh,r.id,r.model)},this.corto=e},beginFrame:function(e){let t=this;t.frametime=performance.now();let r=t.frametime-t.last_frametime;if(t.last_frametime=t.frametime,r<500&&(t.currentFps=.9*t.currentFps+1e3/r*.1),e=t.currentFps,t.frame++,t.candidates=[],e&&t.minFps){t.currentFps=e;const r=t.minFps/e;r>1.1&&(t.currentError*=1.05),r<.9&&(t.currentError*=.95),t.currentError=Math.max(t.targetError,Math.min(t.maxError,t.currentError))}else t.currentError=t.targetError;t.rendered=0,t.realError=1e20,t.totswapped=0},endFrame:function(){this.update()},requestNode:function(e,t){e.status[t]=2,this.cacheSize+=e.nsize[t],e.reqAttempt[t]=0,this.nodes.has(e)||this.nodes.set(e,new Set),this.nodes.get(e).add(t),this.requestNodeGeometry(e,t),this.requestNodeTexture(e,t)},requestNodeGeometry:function(e,t){this.pending++,e.status[t]++;let r=e.deepzoom?e.baseurl+t+".nxn":e.url,o=e.deepzoom?0:e.noffsets[t],s=e.deepzoom?0:e.noffsets[t+1],i=e.georeq[t]=e.httpRequest(r,o,s,(()=>{delete e.georeq[t],this.loadNodeGeometry(i,e,t),this.pending--}),(()=>{delete e.georeq[t],this.debug.verbose&&console.log("Geometry request error!"),this.recoverNode(e,t,0),this.pending--}),(()=>{delete e.georeq[t],this.debug.verbose&&console.log("Geometry request abort!"),this.removeNode(e,t),this.pending--}),"arraybuffer")},requestNodeTexture:function(e,t){if(!e.vertex.texCoord)return;let r=e.patches[3*e.nfirstpatch[t]+2];e.texref[r]++,e.status[t]++;let o=e.deepzoom?e.baseurl+r+".jpg":e.url,s=e.deepzoom?0:e.textures[r],i=e.deepzoom?0:e.textures[r+1],n=e.texreq[r]=e.httpRequest(o,s,i,(()=>{delete e.texreq[r],this.loadNodeTexture(n,e,t,r)}),(()=>{delete e.texreq[r],this.debug.verbose&&console.log("Texture request error!"),this.recoverNode(e,t,1)}),(()=>{delete e.texreq[r],this.debug.verbose&&console.log("Texture request abort!"),this.removeNode(e,t)}),"blob")},recoverNode:function(e,t,r){if(0==e.status[t])return;e.status[t]--;let o=this;if(e.reqAttempt[t]>2)return this.debug.verbose&&console.log("Max request limit for "+m.url+" node: "+n),void o.removeNode(e,t);switch(e.reqAttempt[t]++,r){case 0:o.requestNodeGeometry(e,t),this.debug.verbose&&console.log("Recovering geometry for "+m.url+" node: "+n);break;case 1:o.requestNodeTexture(e,t),this.debug.verbose&&console.log("Recovering texture for "+m.url+" node: "+n)}},loadNodeGeometry:function(e,t,r){0!=t.status[r]&&(t.compressed?(this.corto||this.loadCorto(),this.corto.postRequest({mesh:t,id:r,buffer:e.response,cache:this})):this.readyGeometryNode(t,r,e.response))},loadNodeTexture:function(e,t,r,o){if(0==t.status[r])throw"Should not load texture twice";let s=e.response,i=e=>{0!=t.status[r]&&(t.createTexture(o,e),t.status[r]--,2==t.status[r]&&this.readyNode(t,r))};if("undefined"!=typeof createImageBitmap)try{createImageBitmap(s,{imageOrientation:"flipY"}).then(i)}catch(e){createImageBitmap(s).then(i)}else{var n=window.URL||window.webkitURL,a=document.createElement("img");a.onerror=function(e){console.log("Texture loading error!")},a.src=n.createObjectURL(s),a.onload=function(){n.revokeObjectURL(a.src),i(a)}}},removeNode:function(e,t){if(this.nodes.get(e).delete(t),0==e.status[t])return void(this.debug.verbose&&console.log("Double remove due to abort."));if(e.status[t]=0,t in e.georeq&&4!=e.georeq[t].readyState&&(e.georeq[t].abort(),delete e.georeq[t]),e.availableNodes--,this.cacheSize-=e.nsize[t],e.deleteNodeGeometry(t),!e.vertex.texCoord)return;const r=e.patches[3*e.nfirstpatch[t]+2];r in e.texreq&&4!=e.texreq[r].readyState&&(e.texreq[r].abort(),delete e.texreq[r]),e.texref[r]--,0==e.texref[r]&&e.deleteTexture(r)},readyGeometryNode:function(e,t,r){if(0==e.status[t])return;const o=e.nvertices[t],s=e.nfaces[t];let i={};if(e.corto)i=r;else{i.index=new Uint16Array(r,o*e.vsize,3*s),i.position=new Float32Array(r,0,3*o);var n=12*o;e.vertex.texCoord&&(i.uv=new Float32Array(r,n,2*o),n+=8*o),e.vertex.normal&&(i.normal=new Int16Array(r,n,3*o),n+=6*o),e.vertex.color&&(i.color=new Uint8Array(r,n,4*o),n+=4*o)}e.createNodeGeometry(t,i),e.status[t]--,2==e.status[t]&&this.readyNode(e,t)},readyNode:function(e,t){if(e.status[t]--,1!=e.status[t])throw"A ready node should have status ==1";e.reqAttempt[t]=0,e.createNode(t),e.availableNodes++;for(let t of e.onUpdate)t();this.update()},flush:function(e){if(this.nodes.has(e)){for(let t of this.nodes.get(e))this.removeNode(e,t);this.nodes.delete(e)}},update:function(){if(this.pending>=3)return;let e=null;for(let t of this.candidates)0==t.mesh.status[t.id]&&(!e||t.error>e.error)&&(e=t);if(e){for(;this.cacheSize>this.maxCacheSize;){let t=null;for(let[e,r]of this.nodes)for(let o of r){let r=e.errors[o],s=e.frames[o];(!t||r<t.error)&&(t={id:o,frame:s,error:r,mesh:e})}if(!t||t.error>=.9*e.error)return;this.removeNode(t.mesh,t.id)}this.totswapped+=e.mesh.nsize[e.id],this.candidates=this.candidates.filter((t=>t.mesh==e.mesh&&t.id==e.id)),this.requestNode(e.mesh,e.id),this.update()}}};let b=new v;class g extends o.Mesh{constructor(e,t,r){if(super(),"function"==typeof t)throw"Nexus3D constructor has changed: Nexus3D(url, renderer, options) where options include: onLoad, onUpdate, onProgress and material";this.patchWebGLRenderer(t),Object.assign(this,{isNXS:!0,type:"NXS",url:e,gl:t.getContext(),material:null,autoUpdate:!0,mesh:new x,vbo:[],ibo:[],vao:[],textures:[],attributes:{},basemesh:null}),"material"in r&&(this.material=r.material),this.material||(this.material=new o.MeshStandardMaterial);for(let e of["onLoad","onUpdate","onProgress"])this["_"+e]=[],e in r&&this["_"+e].push(r[e]);this.url&&("object"==typeof e?(this.nxs=this.url,this.nxs.onLoad.push((e=>{this.mesh=this.nxs.mesh,this.traversal=this.nxs.traversal,this.cache=this.nxs.cache,this.vbo=this.nxs.vbo,this.ibo=this.nxs.ibo,this.vao=this.nxs.vao,this.textures=this.nxs.textures,this.onLoadCallback(this)}))):this.open(this.url))}copy(e){throw Object3D.prototype.copy.call(this,e,!1),"Can't really copy."}open(e){let t=this;this.mesh.open(e),this.mesh.createNode=e=>{},this.mesh.createNodeGeometry=(e,r)=>{t.createNodeGeometry(e,r)},this.mesh.createTexture=(e,r)=>{t.createTexture(e,r)},this.mesh.deleteNodeGeometry=e=>{t.deleteNodeGeometry(e)},this.mesh.deleteTexture=e=>{t.deleteTexture(e)},this.mesh.onLoad.push((()=>{t.onLoadCallback()})),this.mesh.onUpdate.push((()=>{for(let e of t._onUpdate)e(this);for(let e of t._onProgress)e(this,this.mesh.availableNodes,this.mesh.nodesCount)})),this.traversal=new d,this.cache=b,this.textures={}}set onLoad(e){this._onLoad.push(e)}set onUpdate(e){this._onUpdate.push(e)}set onProgress(e){this._onProgress.push(e)}updateMaterials(){!1!==this.material.map&&this.mesh.vertex.texCoord&&(this.material.map=this.material_texture),this.mesh.vertex.color&&(this.material.vertexColors=o.VertexColors),this.material.needsUpdate=!0}onLoadCallback(){const e=this.mesh.sphere.center,t=new o.Vector3(e[0],e[1],e[2]),r=this.mesh.sphere.radius;this.boundingSphere=new o.Sphere(t,r);var s=new o.BufferGeometry;s.setAttribute("position",new o.BufferAttribute(new Float32Array(3),3)),this.mesh.vertex.normal&&s.setAttribute("normal",new o.BufferAttribute(new Float32Array(3),3)),this.mesh.vertex.color&&s.setAttribute("color",new o.BufferAttribute(new Float32Array(4),4)),this.mesh.vertex.texCoord&&s.setAttribute("uv",new o.BufferAttribute(new Float32Array(2),2)),this.mesh.vertex.texCoord&&(this.material_texture=new o.DataTexture(new Uint8Array([1,1,1]),1,1,o.RGBFormat),this.material_texture.needsUpdate=!0),this.updateMaterials(),this.geometry=s,this.frustumCulled=!1;for(let e of this._onLoad)e(this)}renderBufferDirect(e,t,r,s,i,n){let a=new o.Vector2;e.getSize(a),this.modelViewMatrix.multiplyMatrices(r.matrixWorldInverse,this.matrixWorld),this.traversal.updateView([0,0,a.width,a.height],r.projectionMatrix.elements,this.modelViewMatrix.elements),this.instance_errors=this.traversal.traverse(this.mesh,this.cache);let h=this.gl,l=h.getParameter(h.CURRENT_PROGRAM),u=this.attributes;u.position=h.getAttribLocation(l,"position"),u.normal=h.getAttribLocation(l,"normal"),u.color=h.getAttribLocation(l,"color"),u.uv=h.getAttribLocation(l,"uv"),u.size=h.getUniformLocation(l,"size"),u.scale=h.getUniformLocation(l,"scale");let d=h.getUniformLocation(l,"map");u.map=d?h.getUniform(l,d):null,this.setVisibility()}setVisibility(){let e=this.traversal,t=this.mesh;if(!t.isReady)return;let r=0,o=this.attributes,s=this.mesh,i=this.gl,n=i instanceof WebGL2RenderingContext,a=o.uv+10*o.color+100*o.normal;for(let x=0;x<t.nodesCount;x++){if(!e.selected[x])continue;{let r=!1;t.nfirstpatch[x+1];for(var h=t.nfirstpatch[x];h<t.nfirstpatch[x+1];++h){var l=t.patches[3*h];if(!e.selected[l]){r=!0;break}}if(!r)continue}var u=t.nspheres,d=5*x;if(!e.isVisible(u[d],u[d+1],u[d+2],u[d+4]))continue;let v=!0;if(n&&(a in this.vao[x]?v=!1:this.vao[x][a]=i.createVertexArray(),i.bindVertexArray(this.vao[x][a])),v){i.bindBuffer(i.ARRAY_BUFFER,this.vbo[x]),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,this.ibo[x]),i.vertexAttribPointer(o.position,3,i.FLOAT,!1,12,0),i.enableVertexAttribArray(o.position);let e=this.mesh.nvertices[x],t=12*e;if(s.vertex.texCoord&&(o.uv>=0&&(i.vertexAttribPointer(o.uv,2,i.FLOAT,!1,8,t),i.enableVertexAttribArray(o.uv)),t+=8*e),s.vertex.color&&(o.color>=0&&(i.vertexAttribPointer(o.color,4,i.UNSIGNED_BYTE,!0,4,t),i.enableVertexAttribArray(o.color)),t+=4*e),s.vertex.normal&&o.normal>=0&&(i.vertexAttribPointer(o.normal,3,i.SHORT,!0,6,t),i.enableVertexAttribArray(o.normal)),this.cache.debug.nodes){i.disableVertexAttribArray(o.color);var c=this.instance_errors[x],f=[[1,1,1,1],[1,1,1,1],[0,1,0,1],[0,1,1,1],[1,1,0,1],[1,0,1,1],[1,0,0,1]];let e=Math.min(5.99,Math.max(0,Math.log2(c)/2)),t=Math.floor(e);e-=t;let r=[];for(let o=0;o<4;o++)r[o]=f[t][o]*(1-e)+f[t+1][o]*e;i.vertexAttrib4fv(o.color,r)}}this.cache.realError=Math.min(this.mesh.errors[x],this.cache.realError);let b=0,g=0,w=t.nfirstpatch[x+1]-1;for(let s=t.nfirstpatch[x];s<t.nfirstpatch[x+1];++s){let n=t.patches[3*s];if(e.selected[n]||(g=t.patches[3*s+1],!(s<w))){if(g>b){if(t.vertex.texCoord&&o.uv>=0){var m=t.patches[3*s+2];if(-1!=m){var p=this.textures[m];i.activeTexture(i.TEXTURE0+o.map),i.bindTexture(i.TEXTURE_2D,p)}}let e=this.material.wireframe?i.LINE_STRIP:i.TRIANGLES;i.drawElements(e,3*(g-b),i.UNSIGNED_SHORT,6*b),r+=g-b}b=t.patches[3*s+1]}}}this.cache.rendered+=r}createNodeGeometry(e,t){let r=this.mesh;var s=r.nvertices[e];r.nfaces[e];let i=t.index,n=new ArrayBuffer(s*r.vsize);new Float32Array(n,0,3*s).set(t.position);var a=12*s;r.vertex.texCoord&&(new Float32Array(n,a,2*s).set(t.uv),a+=8*s);r.vertex.color&&(new Uint8Array(n,a,4*s).set(t.color),a+=4*s);r.vertex.normal&&(new Int16Array(n,a,3*s).set(t.normal),a+=6*s);if(e<this.mesh.nroots){let e=new o.BufferGeometry;e.setAttribute("position",new o.BufferAttribute(t.position,3)),e.setAttribute("normal",new o.BufferAttribute(t.normal,3)),e.setIndex(new o.BufferAttribute(t.index,1)),this.basemesh=new o.Mesh(e,this.material),this.basemesh.visible=!1,this.add(this.basemesh)}var h=this.gl;this.vao[e]={},h.bindVertexArray(null);var l=this.vbo[e]=h.createBuffer();h.bindBuffer(h.ARRAY_BUFFER,l),h.bufferData(h.ARRAY_BUFFER,n,h.STATIC_DRAW);var u=this.ibo[e]=h.createBuffer();h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,u),h.bufferData(h.ELEMENT_ARRAY_BUFFER,i,h.STATIC_DRAW)}createTexture(e,t){let r=this.gl;var o=r.getParameter(r.UNPACK_FLIP_Y_WEBGL);r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,!0);let s=this.textures[e]=r.createTexture();function i(e){return e&&0==(e&e-1)}r.bindTexture(r.TEXTURE_2D,s),r.texImage2D(r.TEXTURE_2D,0,r.RGB,r.RGB,r.UNSIGNED_BYTE,t),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.LINEAR),!(r instanceof WebGLRenderingContext)||i(t.width)&&i(t.height)?(r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.NEAREST_MIPMAP_LINEAR),r.generateMipmap(r.TEXTURE_2D)):r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR),r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,o)}deleteNodeGeometry(e){if(this.gl.deleteBuffer(this.vbo[e]),this.gl.deleteBuffer(this.ibo[e]),this.vbo[e]=this.ibo[e]=null,this.vao[e])for(const[t,r]of Object.entries(this.vao[e]))this.gl.deleteVertexArray(r);this.vao[e]=null}deleteTexture(e){this.textures[e]&&(this.gl.deleteTexture(this.textures[e]),this.textures[e]=0)}flush(){this.cache.flush(this.mesh)}dispose(){this.flush();for(let e of this.children)e.geometry.dispose()}toJSON(e){throw"Can't"}patchWebGLRenderer(e){if(e.nexusPatched)return;let t=e.renderBufferDirect;e.renderBufferDirect=(r,o,s,i,n,a)=>{t(r,o,s,i,n,a),n.renderBufferDirect&&n.renderBufferDirect(e,o,r,s,i,a)},e.originalRender=e.render,e.render=(t,r)=>{b.beginFrame(30),e.originalRender(t,r),b.endFrame()},e.nexusPatched=!0}}e.Cache=b,e.Nexus3D=g,Object.defineProperty(e,"__esModule",{value:!0})}));
